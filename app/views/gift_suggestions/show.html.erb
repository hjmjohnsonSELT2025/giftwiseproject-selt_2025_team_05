<div class="container my-4">
  <h1 class="mb-5 text-center">Gift ideas for <%= @recipient.first_name %> <%= @recipient.last_name %></h1>

  <div class="row g-4 align-items-start">
    <%# Chatgpt helped come up with sizing- particularly for when screen sizes change. Uses bootstrap5 display classes %>
    <div class="col-lg-4">
      <section class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Profile Snapshot</h5>
          <dl class="row mb-3 small">
            <dt class="col-4">Bio:</dt>
            <dd class="col-8"><%= @bio.presence || "No bio yet" %></dd>
            <dt class="col-4">Wishlist:</dt>
            <dd class="col-8"><%= @wishlist.count %> items</dd>
          </dl>

          <% if @wishlist.any? %>
            <ul class="list-group small">
              <% @wishlist.each do |item| %>
                <li class="list-group-item px-2 py-2">
                  <strong><%= item.item_name %></strong>
                  <div class="text-muted">$<%= number_with_precision(item.cost, precision: 2) %></div>
                  <% if item.notes.present? %>
                    <div><em><%= item.notes %></em></div>
                  <% end %>
                </li>
              <% end %>
            </ul>
          <% else %>
            <p class="text-muted mb-0 small">No wishlist items yet.</p>
          <% end %>
        </div>
      </section>

      <section class="card shadow-sm mt-4">
        <div class="card-body">
          <h5 class="card-title">Save Gift Idea</h5>
          <%= form_with model: Suggestion.new, url: suggestions_path, method: :post, local: true do |form| %>
            <%= hidden_field_tag :user_id, current_user.id %>
            <%= hidden_field_tag :recipient_id, @recipient.id %>
            <%= hidden_field_tag :event_id, @event.id %>
            <%= hidden_field_tag :redirect_to, event_event_user_gift_suggestions_path(@event, @event_user) %>

            <div class="row g-3">
              <div class="col-8">
                <%= form.label :item_name, "Gift idea", class: "form-label" %>
                <%= form.text_field :item_name, required: true, class: "form-control" %>
              </div>
              <div class="col-4">
                <%= form.label :cost, "Cost", class: "form-label" %>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <%= form.number_field :cost, step: 0.01, min: 0, class: "form-control", placeholder: "50.00" %>
                </div>
              </div>
            </div>

            <div class="mb-3 mt-3">
              <%= form.label :notes, "Notes", class: "form-label" %>
              <%= form.text_area :notes, rows: 2, class: "form-control", placeholder: "Link, size, or reason for gift" %>
            </div>

            <div class="d-grid">
              <%= form.submit "Save Gift Idea", class: "btn btn-success" %>
            </div>
          <% end %>

          <hr class="my-4">

          <h6 class="fw-semibold">Your current gift ideas for <%= @recipient.first_name %> </h6>
          <% if @saved_gifts.any? %>
            <div class="table-responsive">
              <table class="table table-striped table-sm align-middle mb-0">
                <thead>
                <tr>
                  <th>Item</th>
                  <th>Cost</th>
                  <th>Purchased?</th>
                </tr>
                </thead>
                <tbody>
                <% @saved_gifts.each do |gift| %>
                  <tr>
                    <td class="small"><%= gift.item_name.presence || "Untitled idea" %></td>
                    <td class="small"><%= gift.cost.present? ? number_to_currency(gift.cost) : "—" %></td>
                    <td class="small"><%= gift.purchased ? "Yes" : "No" %></td>
                  </tr>
                <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <p class="text-muted small mb-0">No saved ideas yet.</p>
          <% end %>
        </div>
      </section>
    </div>

    <div class="col-lg-8">
      <section class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-3">Gift Suggestion Assistant</h5>

          <% if @conversation.any? %>
            <div class="chat-thread mb-3">
              <% @conversation.each do |message| %>
                <% from_user = message[:role] == "user" %>
                <div class="chat-bubble <%= from_user ? 'chat-bubble-user' : 'chat-bubble-assistant' %>">
                  <small class="text-muted d-block mb-1"><%= from_user ? "You" : "Assistant" %></small>
                  <p class="mb-0"><%= simple_format(message[:content]) %></p>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="text-muted">Chat with Gift Wise's personal gift suggesting assistant! Begin by either furthur describing the person, specifiying a gift theme, or request to refine gift ideas</p>
          <% end %>

          <%= form_with url: event_event_user_gift_suggestions_path(@event, @event_user), method: :post, local: true, data: { turbo: false }, id: "gift-chat-form" do |form| %>
            <%= hidden_field_tag :conversation, @serialized_conversation %>

            <div class="mb-3">
              <%= form.label :prompt, "Ask for ideas", class: "form-label fw-semibold" %>
              <%= form.text_area :prompt, rows: 3, class: "form-control", placeholder: "Generate 3 gift ideas based on #{@recipient.first_name}'s interests"%>
            </div>

            <div class="text-end">
              <%= form.submit "Ask the assistant", class: "btn btn-outline-primary" %>
            </div>
          <% end %>
        </div>
      </section>
    </div>
  </div>


  <%= link_to "Back", user_gift_summary_path(user_id: @recipient.id, event_id: @event.id), class: "btn btn-secondary mt-4" %>
</div>

<%# Chatgpt came up with this logic of adding "Thinking" text to the button after a chat is submitted %>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("gift-chat-form");
        if (!form) return;

        form.addEventListener("submit", () => {
            const button = form.querySelector("input[type='submit']");
            if (!button) return;
            button.disabled = true;
            button.value = "Thinking…";
            button.classList.add("disabled");
        });
    });
</script>